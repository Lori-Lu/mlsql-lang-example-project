[{"kind":2,"language":"python","value":"#%python\n#%input=command\n#%output=b_output\n#%cache=true\n#%schema=st(field(features,array(double)),field(label,long)))\n#%dataMode=model\n#%env=source /Users/allwefantasy/opt/anaconda3/bin/activate ray1.7.0\n\nfrom sklearn.datasets import load_breast_cancer\nfrom pyjava.api.mlsql import RayContext,PythonContext\n\ncontext: PythonContext = context\nray_context = RayContext.connect(globals(), None)\ntrain_x, train_y = load_breast_cancer(return_X_y=True)\nrows = [{\"features\":row[0],\"label\":row[1]} for row in zip(train_x.tolist(),train_y.tolist())]\ncontext.build_result(rows)","outputs":[]},{"kind":2,"language":"mlsql","value":"save overwrite b_output as delta.`data.breast_cancer`;","outputs":[]},{"kind":2,"language":"mlsql","value":"load delta.`data.breast_cancer` as newTable;","outputs":[]},{"kind":2,"language":"mlsql","value":"\n!python env \"PYTHON_ENV=source activate ray1.7.0\";\n\nset inModule=\"false\";\nset inputTable=\"newTable\";\nset outputTable=\"xgboostModelTable\";\nset rayAddress=\"127.0.0.1:10001\";\n\ninclude project.`src/algs/xgboost.mlsql`;\nsave overwrite xgboostModelTable as delta.`model.xgboost_breast_cancer`;","outputs":[{"mime":"x-application/mlsql-notebook","value":"{\n\t\"schema\": {\n\t\t\"type\": \"struct\",\n\t\t\"fields\": [\n\t\t\t{\n\t\t\t\t\"name\": \"owner\",\n\t\t\t\t\"type\": \"string\",\n\t\t\t\t\"nullable\": true,\n\t\t\t\t\"metadata\": {}\n\t\t\t},\n\t\t\t{\n\t\t\t\t\"name\": \"jobType\",\n\t\t\t\t\"type\": \"string\",\n\t\t\t\t\"nullable\": true,\n\t\t\t\t\"metadata\": {}\n\t\t\t},\n\t\t\t{\n\t\t\t\t\"name\": \"jobName\",\n\t\t\t\t\"type\": \"string\",\n\t\t\t\t\"nullable\": true,\n\t\t\t\t\"metadata\": {}\n\t\t\t},\n\t\t\t{\n\t\t\t\t\"name\": \"jobContent\",\n\t\t\t\t\"type\": \"string\",\n\t\t\t\t\"nullable\": true,\n\t\t\t\t\"metadata\": {}\n\t\t\t},\n\t\t\t{\n\t\t\t\t\"name\": \"groupId\",\n\t\t\t\t\"type\": \"string\",\n\t\t\t\t\"nullable\": true,\n\t\t\t\t\"metadata\": {}\n\t\t\t},\n\t\t\t{\n\t\t\t\t\"name\": \"progress\",\n\t\t\t\t\"type\": {\n\t\t\t\t\t\"type\": \"struct\",\n\t\t\t\t\t\"fields\": [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"name\": \"totalJob\",\n\t\t\t\t\t\t\t\"type\": \"long\",\n\t\t\t\t\t\t\t\"nullable\": false,\n\t\t\t\t\t\t\t\"metadata\": {}\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"name\": \"currentJobIndex\",\n\t\t\t\t\t\t\t\"type\": \"long\",\n\t\t\t\t\t\t\t\"nullable\": false,\n\t\t\t\t\t\t\t\"metadata\": {}\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"name\": \"script\",\n\t\t\t\t\t\t\t\"type\": \"string\",\n\t\t\t\t\t\t\t\"nullable\": true,\n\t\t\t\t\t\t\t\"metadata\": {}\n\t\t\t\t\t\t}\n\t\t\t\t\t]\n\t\t\t\t},\n\t\t\t\t\"nullable\": true,\n\t\t\t\t\"metadata\": {}\n\t\t\t},\n\t\t\t{\n\t\t\t\t\"name\": \"startTime\",\n\t\t\t\t\"type\": \"long\",\n\t\t\t\t\"nullable\": false,\n\t\t\t\t\"metadata\": {}\n\t\t\t},\n\t\t\t{\n\t\t\t\t\"name\": \"timeout\",\n\t\t\t\t\"type\": \"long\",\n\t\t\t\t\"nullable\": false,\n\t\t\t\t\"metadata\": {}\n\t\t\t}\n\t\t]\n\t},\n\t\"data\": [\n\t\t{\n\t\t\t\"owner\": \"admin\",\n\t\t\t\"jobType\": \"script\",\n\t\t\t\"jobName\": \"6c6b30e1-610f-4703-b95e-921a651efc1d\",\n\t\t\t\"jobContent\": \"\\n!python env \\\"PYTHON_ENV=source activate ray1.7.0\\\";\\n\\nset inModule=\\\"false\\\";\\nset inputTable=\\\"newTable\\\";\\nset outputTable=\\\"xgboostModelTable\\\";\\nset rayAddress=\\\"127.0.0.1:10001\\\";\\n\\ninclude project.`src/algs/xgboost.mlsql`;\\nsave overwrite xgboostModelTable as delta.`model.xgboost_breast_cancer`;\",\n\t\t\t\"groupId\": \"30087a29-0475-4bce-9f91-834ad44994f2\",\n\t\t\t\"progress\": {\n\t\t\t\t\"totalJob\": 17,\n\t\t\t\t\"currentJobIndex\": 17,\n\t\t\t\t\"script\": \"save overwrite xgboostModelTable as delta.`model.xgboost_breast_cancer`\"\n\t\t\t},\n\t\t\t\"startTime\": 1637205971688,\n\t\t\t\"timeout\": -1\n\t\t}\n\t]\n}"}]},{"kind":2,"language":"mlsql","value":"!python env \"PYTHON_ENV=source activate ray1.7.0\";\nload delta.`data.breast_cancer` as newTable;","outputs":[]},{"kind":2,"language":"mlsql","value":"-- 引入xgboost 实现\ninclude lib.`github.com/allwefantasy/lib-core` where \n-- force=\"true\" and\nalias=\"libCore\";","outputs":[{"mime":"x-application/mlsql-notebook","value":"{\n\t\"schema\": {\n\t\t\"type\": \"struct\",\n\t\t\"fields\": []\n\t},\n\t\"data\": []\n}"}]},{"kind":2,"language":"mlsql","value":"-- xgboost算法配置项\nset inputTable=\"newTable\";\nset outputTable=\"xgboostModelTable\";\nset rayAddress=\"127.0.0.1:10001\";\ninclude local.`libCore.alg.xgboost`;","outputs":[]},{"kind":2,"language":"mlsql","value":"-- XgboostExt 只是包裹了上面的脚本\ntrain newTable as XGBoostExt.`data.breast_cancer` \nwhere rayAddress=\"127.0.0.1:10001\" \nas xgboostModelTable;","outputs":[{"mime":"x-application/mlsql-notebook","value":"{\n\t\"schema\": {\n\t\t\"type\": \"struct\",\n\t\t\"fields\": [\n\t\t\t{\n\t\t\t\t\"name\": \"files\",\n\t\t\t\t\"type\": \"string\",\n\t\t\t\t\"nullable\": true,\n\t\t\t\t\"metadata\": {}\n\t\t\t}\n\t\t]\n\t},\n\t\"data\": [\n\t\t{\n\t\t\t\"files\": \"model.xgb\"\n\t\t}\n\t]\n}"}]},{"kind":2,"language":"mlsql","value":"\n\nselect \n#set($colums=[\"features\",\"label\"])\n#foreach( $column in $colums )\n    SUM( case when `$column` is null or `$column`='' then 1 else 0 end ) as $column,\n#end\n 1 as a from newTable as output;","outputs":[]},{"kind":2,"language":"mlsql","value":"set sum_tpl = '''\nSUM( case when `{0}` is null or `{0}`='' then 1 else 0 end ) as {0}\n''';\n\nselect ${template.get(\"sum_tpl\",\"diagnosis\")},\n${template.get(\"sum_tpl\",\"radius_mean\")},\n${template.get(\"sum_tpl\",\"texture_mean\")},\n....","outputs":[]}]