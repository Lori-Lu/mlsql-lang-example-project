[{"kind":1,"language":"markdown","value":"## 修改图片大小\n\n这个示例，我们会教会大家\n\n1. 下载,解压cifar数据集\n2.  加载数据集\n3.  使用python脚本分布式处理图片（需要本地开启ray）\n4. 将处理后的图片保存到新的目录中\n\n启动ray很简单：\n\nray的版本为1.3.0.\n\n```\nray start --head\n```","outputs":[]},{"kind":1,"language":"markdown","value":"使用shell命令下载和解压cifar数据图片","outputs":[]},{"kind":2,"language":"mlsql","value":"!sh wget \"https://github.com/allwefantasy/spark-deep-learning-toy/releases/download/v0.01/cifar.tgz\";","outputs":[]},{"kind":2,"language":"mlsql","value":"!sh mkdir -p /tmp/cifar10;\n!sh tar -xf \"cifar.tgz\" \"-C\" \"/tmp/cifar10\";\n!copyFromLocal ","outputs":[]},{"kind":2,"language":"mlsql","value":"include project.`./src/common/PyHeader.mlsql`;","outputs":[]},{"kind":2,"language":"mlsql","value":"load binaryFile.`/tmp/cifar10/cifar/train/*.png` as cifar10;\nrun cifar10 as TableRepartition.`` where partitionNum=\"4\" as newCifar10;\nsave overwrite newCifar10 as delta.`data.raw_cifar10`;","outputs":[]},{"kind":2,"language":"mlsql","value":"load delta.`data.raw_cifar10` as raw_cifar10_table;\n!emptyTable;","outputs":[]},{"kind":1,"language":"markdown","value":"### 我们需要对cifar10表里的图片进行处理。这里你需要确保你的python环境安装有 opencv2\n\n可以按如下方式安装：\n\n```\npip install opencv-python\n```","outputs":[]},{"kind":2,"language":"python","value":"#%python\n#%input=raw_cifar10_table\n#%output=cifar10_resize\n#%cache=true\n#%schema=st(field(content,binary),field(path,string))\n#%dataMode=data\n\nimport io,cv2,numpy as np\nfrom pyjava.api.mlsql import RayContext\n\nray_context = RayContext.connect(globals(),\"127.0.0.1:10001\")\n\ndef resize_image(row):\n    new_row = {}\n    image_bin = row[\"content\"]    \n    oriimg = cv2.imdecode(np.frombuffer(io.BytesIO(image_bin).getbuffer(),np.uint8),1)\n    newimage = cv2.resize(oriimg,(28,28))\n    is_success, buffer = cv2.imencode(\".png\", newimage)\n    io_buf = io.BytesIO(buffer)\n    new_row[\"content\"]=io_buf.getvalue()\n    new_row[\"path\"]=row[\"path\"]\n    return new_row\n\nray_context.foreach(resize_image)","outputs":[]},{"kind":2,"language":"mlsql","value":"-- 引入一些函数，方便在SQL中使用\ninclude project.`./src/common/functions.mlsql`;","outputs":[]},{"kind":2,"language":"mlsql","value":"-- 这里，arrayLast 函数来源于 ./src/common/functions.mlsql 中\n\nselect arrayLast(split(path,\"/\")) as fileName,content  \nfrom cifar10_resize \nas final_dataset;\n\nsave overwrite final_dataset as image.`/tmp/size-28x28` \nwhere imageColumn=\"content\" \nand fileName=\"fileName\";","outputs":[]}]